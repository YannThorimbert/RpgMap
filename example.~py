#First, test the dependecies and show the user a message if smth is missing.
import dependenciescheck as dc
dc.check_console("pygame")
dc.check_console("thorpy") #for GUI and graphic effects - see www.thorpy.org
dc.check_gui("numpy")
dc.check_gui("PIL")
#Now the imports
import pygame
import thorpy
import gui.gui as gui
from logic.game import Game, get_sprite_frames
################################################################################

W,H = 1200, 700 #screen size
app = thorpy.Application((W,H))
FPS = 80

import random
from PyWorld2D.editor.mapbuilding import MapInitializer, terrain_plains, terrain_flat, terrain_small, terrain_medium
from PyWorld2D.thornoise.purepython.noisegen import colorscale_plains, colorscale_flat, colorscale_normal

def generate_map():
    mi = MapInitializer("First demo map")
    mi.chunk = (random.randint(0,1000), random.randint(0,1000))
    wm,hm = 16,16
    mi.world_size = (wm,hm)
##    mi.set_terrain_type(terrain_plains, colorscale_normal)
    mi.set_terrain_type(terrain_medium, colorscale_normal)
    mi.max_number_of_roads = random.randint(0, 6)
    mi.max_number_of_rivers = random.randint(0, 6)
    mi.zoom_cell_sizes = [32, 16]
    mi.seed_static_objects = random.randint(0,1000)
    me = mi.configure_map_editor(FPS) #me = "Map Editor"
    img = me.get_hmap_img((wm*10,hm*10))
    print("CHUNK", mi.chunk, mi.seed_static_objects)
    return me, img, mi
    ####mi = maps.map1 #go in mymaps.py and PLAY with PARAMS !!!
    ##maps.map1.chunk = (1322, 43944)
    ##maps.map1.max_number_of_roads = 5 #5
    ##maps.map1.max_number_of_rivers = 5 #5
    ##maps.map1.village_homogeneity = 0.1
    ##maps.map1.seed_static_objects = 15
    ##maps.map1.zoom_cell_sizes = [32]

def refresh():
    global me, mi
    me, img, mi = generate_map()
    me.screen.fill((255,255,255))
    button_img_map.get_elements()[0].set_image(img)
    for button_genmap in els:
        button_genmap.blit()
    pygame.display.flip()

button_genmap = thorpy.make_button("Generate another map", refresh)
me, img, mi = generate_map()
button_img_map = thorpy.Clickable(elements=[thorpy.Image(img)])
button_img_map.fit_children()
button_img_map.user_func = thorpy.functions.quit_menu_func
buttons = [button_genmap,button_img_map]
thorpy.store("screen", els)
me.screen.fill((255,255,255))
pygame.display.flip()
m = thorpy.Menu(buttons)
m.play()
game = Game(me)


#<fast> : quality a bit lower if true, loading time a bit faster.
#<use_beach_tiler>: quality much better if true, loading much slower.
#<load_tilers> : Very slow but needed if you don't have Numpy but still want HQ.
game.build_map(mi, fast=False, use_beach_tiler=True, load_tilers=False)
ui = gui.Gui(game)
me.set_zoom(level=0)

m = thorpy.Menu(me.e_box,fps=me.fps)
m.play()

app.quit()
